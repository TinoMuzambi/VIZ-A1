---
title: "Chloropleth"
output: pdf_document
date: "2024-03-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries

```{r}
library(tidyverse)
library(tmap)
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(scales)
```

# Read in data

```{r}
spotify <- read.csv("./data/final.csv")%>% 
  filter(country != "country") %>% 
  filter(country != "Global") %>% 
  dplyr::select(streams, country, danceability, energy, loudness, liveness, acousticness, speechiness) %>% 
  mutate(streams = as.numeric(streams), danceability = as.numeric(danceability), energy = as.numeric(energy), loudness = as.numeric(loudness), liveness = as.numeric(liveness), acousticness = as.numeric(acousticness), speechiness = as.numeric(speechiness))
```

# Group data by country

```{r}
spotify.country <- spotify %>% 
  group_by(country) %>% 
  summarise(streams = sum(streams), danceability = mean(danceability), energy = mean(energy), loudness = mean(loudness), liveness = mean(liveness), acousticness = mean(acousticness), speechiness = mean(speechiness)) %>% 
  mutate(dancelevel = ifelse(danceability >=0 & danceability < 0.33, "low", ifelse(danceability >= 0.33 & danceability < 0.66, "moderate", "high"))) %>% 
  mutate(logloudness = log10(abs(loudness)))
```

# Fix country names

```{r}
spotify.country <- spotify.country %>% 
  mutate(country = ifelse(country == "United States", "United States of America", country)) %>% 
  mutate(country = ifelse(country == "Czech Republic", "Czechia", country)) %>% 
  mutate(country = ifelse(country == "Dominican Republic", "Dominican Rep.", country)) %>% 
  mutate(country = ifelse(country == "Korea", "South Korea", country))
```


# Get world map data

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  filter(sovereignt != "Antarctica")
```

# Join world map with Spotify data

```{r}
world.data <- left_join(world, spotify.country, by = c("sovereignt" = "country"))
```


# Setup danceability icons

```{r}
dance.icons = tmap_icons(c("./World Map/public/high-dance.png", 
                        "./World Map/public/moderate-dance.png",
                        "./World Map/public/low-dance.png" 
                        ))
```

# Create chloropleths.

```{r}
breaks <- c(0, 15e9, 30e9, 45e9, 60e9)

streams.energy.dance1 <- tm_shape(world.data, title = "Streams") +
  tm_fill("streams", title = "Streams", palette = "Greens", breaks = breaks) +
  tm_shape(world.data) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_shape(world.data) +
  tm_bubbles("energy", col = "danceability", n = 3,
             style="fixed", 
             breaks=c(0, 0.33, 0.66, 1),
             palette="Blues",
             size = 0.2,
             title.size="Energy", 
             title.col="Danceability") + 
  tm_format("World") + 
  tm_layout(frame = FALSE, legend.position = c("left", "center"), legend.show = F)
streams.energy.dance1

streams.energy.loud.dance <- tm_shape(world.data, title = "Streams") +
  tm_fill("streams", title = "Streams", palette = "Greens", breaks = breaks) +
  tm_shape(world.data) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_shape(world.data) +
  tm_bubbles("logloudness", 
             col = "energy",
             shape = 22,
             style="fixed", 
             border.lwd = 0.1,
             breaks=c(0.5, 0.6, 0.7, 0.8),
             palette="Blues", 
             title.size="Loudness", 
             title.col="Energy",
             sizes.legend = c(0.6, 0.79, 1),
             scale = 0.9) + 
  tm_shape(world.data) +
  tm_symbols(shape = "dancelevel", shapes = dance.icons, border.lwd = 0, size = 0.2, title.shape = "Danceability") +
  tm_layout(frame = FALSE, legend.position = c("left", "center"), legend.show = F, inner.margins = 0,  bg.color = "orange")
streams.energy.loud.dance

tmap_save(streams.energy.loud.dance, filename = "./plots/Chloropleth Bubbles.png", dpi = 1500, scale = 2)
```

# Distributions

```{r}
# Streams distribution

streams.dist <- spotify.country %>% 
  ggplot(aes(streams)) +
  geom_histogram(binwidth = 2 * IQR(spotify.country$streams) / length(spotify.country$streams)^(1/3), fill="lightgreen", width = 0.1) +
  theme_minimal() +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = seq(min(spotify.country$streams), max(spotify.country$streams), length.out = 5), labels = label_number(scale = 1/1e9, suffix = " billion")) +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())
streams.dist

ggsave("./plots/StreamsDist.png", plot = streams.dist, dpi = 300)
```

```{r}
# Loudness distribution

loudness.dist <- spotify.country %>% 
  ggplot(aes(logloudness)) +
  geom_histogram(binwidth = 2 * IQR(spotify.country$logloudness, na.rm = T) / length(spotify.country$logloudness)^(1/3), fill="lightgreen", width = 0.1) +
  theme_minimal() +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = seq(0.6, 1, length.out = 5)) +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())
loudness.dist

ggsave("./plots/LoudnessDist.png", plot = loudness.dist, dpi = 300)
```

```{r}
# Energy Distribution

energy.dist <- spotify.country %>% 
  ggplot(aes(energy)) +
  geom_histogram(binwidth = 2 * IQR(spotify.country$energy, na.rm = T) / length(spotify.country$energy)^(1/3), fill="lightgreen", width = 0.1) +
  theme_minimal() +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = seq(0.6, 1, length.out = 5)) +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())
energy.dist

ggsave("./plots/EnergyDist.png", plot = energy.dist, dpi = 300)
```

```{r}
# Danceability Distribution

danceability.dist <- spotify.country %>% 
  ggplot(aes(dancelevel)) +
  geom_bar(fill="lightgreen", position = position_dodge(width = 0.1)) +
  theme_minimal() +
  labs(x = NULL, y = NULL) +
  theme(plot.title = element_text(hjust = 0.5), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.text.x = element_blank(), axis.text.y = element_blank())
danceability.dist

ggsave("./plots/DanceDist.png", plot = danceability.dist, dpi = 300)
```


# South Africa Zoom

```{r}
sa <- ne_countries(country = "South Africa", scale = "medium", returnclass = "sf")

sa.data <- left_join(sa, spotify.country, by = c("sovereignt" = "country"))

sa.streams.energy.loud.dance <- tm_shape(sa.data, title = "Streams") +
  tm_fill("streams", title = "Streams", palette = "Greens", breaks = breaks) +
  tm_shape(sa.data) +
  tm_borders(col = "black", lwd = 0.5) +
  tm_shape(sa.data) +
  tm_bubbles("logloudness", 
             col = "energy",
             shape = 22,
             style="fixed",
             border.lwd = 0.1,
             breaks=c(0.5, 0.6, 0.7, 0.8),
             palette="Blues", 
             title.size="Loudness", 
             title.col="Energy",
             sizes.legend = c(0.6, 0.79, 1)) + 
  tm_shape(sa.data) +
  tm_symbols(shape = "dancelevel", shapes = dance.icons, border.lwd = 0, alpha  = 0.1, size = 0.2, title.shape = "Danceability") +
  tm_layout(frame = FALSE, legend.position = c("left", "center"), legend.show = F, inner.margins = 0,  bg.color = "orange")
sa.streams.energy.loud.dance
tmap_save(sa.streams.energy.loud.dance, filename = "./plots/Chloropleth Bubbles SA.png", dpi = 1500, scale = 2)
```

